AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31

Parameters:
  StageName:
    Description: Etapa de implantação. Utilizada também para definir ambiente de execução.
    Type: String
    AllowedValues:
      - prod
      - stage
      - dev
    Default: dev

  DatabaseHost:
    Description: URI do host do banco de dados
    Type: String

  DatabasePort:
    Description: Porta do host do banco de dados
    Type: String

  DatabaseUser:
    Description: Nome de usuário do banco de dados
    Type: String

  DatabasePass:
    Description: Senha do usuário do banco de dados
    Type: String

  DatabaseName:
    Description: Nome do banco de dados
    Type: String

    Type: String
    Default: "256"

Globals:
  Function:
    Timeout: 30
    MemorySize: 128
    Environment:
      Variables:
        ENVIRONMENT: !Ref StageName
        DATABASE_HOST: !Ref DatabaseHost
        DATABASE_PORT: !Ref DatabasePort
        DATABASE_USER: !Ref DatabaseUser
        DATABASE_PASS: !Ref DatabasePass
        DATABASE_NAME: !Ref DatabaseName

Conditions:
  DevelopmentOnlyResources: !Equals
    - !Ref StageName
    - dev

Resources:
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref StageName
      Auth:
        DefaultAuthorizer: TokenAuthorizer
        ApiKeyRequired: false
        Authorizers:
          TokenAuthorizer:
            FunctionPayloadType: TOKEN
            FunctionArn: !GetAtt TokenAuthorizerFunction.Arn
            Identity:
              Header: Authorization # Deverá conter o CPF do cliente

  TokenAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/tokenAuthorizer.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64

  # Usado apenas para testes locais
  DestinationTestFunction:
    Condition: DevelopmentOnlyResources # Evita criar o Lambda em produć
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/destinationTest.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Events:
        TestAuthorizer:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /test
            Method: GET
